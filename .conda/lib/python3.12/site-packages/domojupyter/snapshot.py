from domojupyter.jupyterhub import Jupyterhub
from domojupyter.domo import Domo, DomoHubAuthentication
from domojupyter.models.CreateSnapshotRequest import CreateSnapshotRequest
import os
import time

__all__ = ['create_snapshot', 'list_snapshots']

jupyterhub_services_url = os.getenv('JUPYTERHUB_SERVICES_URL', None)
jupyterhub_api_token = os.getenv('JUPYTERHUB_API_TOKEN', None)
domo_hostname = os.getenv('DOMO_HOSTNAME', None)
domo_resource_token = os.getenv('DOMO_RESOURCE_TOKEN')
workspace_id = os.getenv('DOMO_WORKSPACE_ID', None)
workspace_session_id = os.getenv('DOMO_WORKSPACE_SESSION_ID', None)

_jupyterhub = Jupyterhub(jupyterhub_services_url, jupyterhub_api_token, workspace_id, workspace_session_id)
_domo = Domo(domo_hostname, DomoHubAuthentication(_jupyterhub), workspace_id)


def create_snapshot(snapshot_name, block=True):
    """
    Creates a snapshot of the current python environment

    Parameters:
        snapshot_name (str): name of the snapshot
        block (bool): whether to block until the snapshot is created

    Returns:
        snapshot_id (str): id of the snapshot
    """
    print("Creating snapshot: " + snapshot_name)
    create_snapshot_request = CreateSnapshotRequest(snapshot_name)
    create_snapshot_response = _domo.create_snapshot(create_snapshot_request.to_json(), workspace_id)
    new_snapshot_id = create_snapshot_response['id']
    if block:
        while True:
            all_snapshots = _domo.list_snapshots(workspace_id)
            new_snapshot = [snapshot for snapshot in all_snapshots if snapshot['id'] == new_snapshot_id][0]
            new_snapshot_status = new_snapshot['status']
            print("Snapshot status: " + new_snapshot_status)
            if new_snapshot_status == 'SUCCESS':
                break
            elif new_snapshot_status == 'FAILED':
                raise Exception(new_snapshot['failureReason'])
            time.sleep(5)
    return create_snapshot_response


def list_snapshots():
    """
    Lists all snapshots

    Returns:
        snapshots (list[Snapshot]): list of snapshots
    """
    list_snapshots_response = _domo.list_snapshots(workspace_id)
    return list_snapshots_response
